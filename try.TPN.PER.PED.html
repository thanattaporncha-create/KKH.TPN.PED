<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN Calculator</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { box-sizing: border-box; font-family: 'Sarabun','Noto Sans Thai',Arial,sans-serif; margin:0; padding:20px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100%; }
    .container { max-width:800px; margin:0 auto; background:white; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; }
    .header { background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); color:white; padding:30px; text-align:center; }
    .header h1 { margin:0 0 10px 0; font-size:2.2em; font-weight:600; }
    .header p { margin:0; font-size:1.1em; opacity:.9; }
    .content { padding:30px; }
    .section { background:#f8fafc; border-radius:12px; padding:25px; margin-bottom:25px; border-left:4px solid #4facfe; }
    .section h2 { color:#2d3748; margin:0 0 20px 0; font-size:1.4em; font-weight:600; }
    .input-group { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    .input-field { display:flex; flex-direction:column; }
    .input-field label { color:#4a5568; font-weight:500; margin-bottom:8px; font-size:.95em; }
    .input-with-unit { display:flex; align-items:center; position:relative; }
    .input-field input { padding:12px 16px; border:2px solid #e2e8f0; border-radius:8px; font-size:1em; transition:all .3s ease; background:white; flex:1; padding-right:60px; -webkit-appearance:none; -moz-appearance:textfield; }
    .input-field input::-webkit-outer-spin-button,.input-field input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .input-field input:focus { outline:none; border-color:#4facfe; box-shadow:0 0 0 3px rgba(79,172,254,.1); }
    .unit { position:absolute; right:16px; color:#718096; font-size:.9em; font-weight:500; pointer-events:none; background:white; padding-left:8px; }
    .tpn-table { background:white; border-radius:12px; overflow:hidden; margin-top:20px; border:2px solid #e2e8f0; width:100%; display:table; table-layout:fixed; }
    .table-header { display:table-row; background:#f8fafc; border-bottom:2px solid #e2e8f0; }
    .table-row { display:table-row; border-bottom:1px solid #f1f5f9; }
    .table-row:last-child { border-bottom:none; }
    .table-cell { display:table-cell; padding:10px 8px; text-align:center; vertical-align:middle; min-height:50px; box-sizing:border-box; border-right:1px solid #f1f5f9; }
    .table-cell:last-child { border-right:none; }
    .header-cell { font-weight:600; color:#2d3748; background:#f8fafc; font-size:.9em; width:25%; }
    .component-cell { font-weight:500; color:#2d3748; text-align:left; padding-left:16px; font-size:.95em; width:25%; }
    .result-cell { font-weight:600; color:#0369a1; background:#f0f9ff; font-size:.85em; text-align:center; width:25%; }
    .result-cell.volume-yellow { background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
    .result-cell.osmol-purple { background:#f3e8ff; color:#7c3aed; border:1px solid #c4b5fd; }
    .gir-display { display:flex; justify-content:space-between; align-items:center; background:white; border-radius:8px; padding:15px; margin-top:15px; border:2px solid #e2e8f0; }
    .gir-label { font-weight:500; color:#2d3748; }
    .calc-result { background:#f0f9ff; padding:8px 12px; border-radius:6px; text-align:center; font-weight:600; color:#0369a1; border:1px solid #bae6fd; }
    .calc-result.gir-pink { background:#fce7f3; color:#be185d; border:1px solid #f9a8d4; }
    .calculation-section { background:white; border-radius:12px; padding:20px; margin-top:15px; border:2px solid #e2e8f0; }
    .calc-row { display:grid; grid-template-columns:2fr 1fr 1fr; gap:15px; align-items:center; padding:12px 0; border-bottom:1px solid #f1f5f9; }
    .calc-row:last-child { border-bottom:none; }
    .calc-label { font-weight:500; color:#2d3748; }
    .total-section { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border-radius:12px; padding:25px; text-align:center; margin-top:25px; }
    .total-section h2 { margin:0 0 15px 0; font-size:1.6em; }
    .total-calories { font-size:2.5em; font-weight:700; margin:10px 0; }
    
    /* New electrolyte styles */
    .electrolyte-item { background:white; border-radius:8px; padding:20px; margin-bottom:15px; border:2px solid #e2e8f0; }
    .electrolyte-header { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px; }
    .electrolyte-input { display:flex; flex-direction:column; }
    .electrolyte-input label { color:#4a5568; font-weight:600; margin-bottom:8px; font-size:1em; }
    .electrolyte-input input { padding:12px 16px; border:2px solid #e2e8f0; border-radius:8px; font-size:1em; transition:all .3s ease; background:white; -webkit-appearance:none; -moz-appearance:textfield; }
    .electrolyte-input input::-webkit-outer-spin-button,.electrolyte-input input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .electrolyte-input input:focus { outline:none; border-color:#4facfe; box-shadow:0 0 0 3px rgba(79,172,254,.1); }
    .electrolyte-result { background:#f0fdf4; border:2px solid #86efac; border-radius:8px; padding:12px; text-align:center; }
    .electrolyte-result-label { font-size:0.85em; color:#166534; font-weight:500; margin-bottom:4px; }
    .electrolyte-result-value { font-size:1.3em; color:#166534; font-weight:700; }
    .source-selection { margin-top:15px; padding-top:15px; border-top:1px solid #e2e8f0; }
    .source-selection h4 { margin:0 0 12px 0; color:#2d3748; font-size:0.95em; font-weight:600; }
    .source-option { display:flex; align-items:center; padding:10px; margin-bottom:8px; border-radius:6px; background:#f8fafc; transition:all .2s ease; cursor:pointer; }
    .source-option:hover { background:#f0f9ff; }
    .source-option input[type="radio"] { margin-right:12px; transform:scale(1.3); cursor:pointer; }
    .source-option-label { flex:1; font-weight:500; color:#2d3748; }
    .source-option-value { background:#dbeafe; color:#1e40af; padding:6px 12px; border-radius:4px; font-weight:600; font-size:0.9em; min-width:60px; text-align:center; }
    
    /* Add styles for HN and Ward */
    .order-inputs { background:#f8fafc; border-radius:12px; padding:25px; margin-bottom:25px; border-left:4px solid #4facfe; }
    .order-inputs h2 { color:#2d3748; margin:0 0 20px 0; font-size:1.4em; font-weight:600; }
    .input-group-order { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .input-field-order { display:flex; flex-direction:column; }
    .input-field-order label { color:#4a5568; font-weight:500; margin-bottom:8px; font-size:.95em; }
    .input-field-order input { padding:12px 16px; border:2px solid #e2e8f0; border-radius:8px; font-size:1em; transition:all .3s ease; background:white; -webkit-appearance:none; -moz-appearance:textfield; }
    .input-field-order input:focus { outline:none; border-color:#4facfe; box-shadow:0 0 0 3px rgba(79,172,254,.1); }
    .btn { border-radius:6px; background:#2563eb; color:white; border:none; font-size:1em; padding:10px 28px; font-weight:600; cursor:pointer; }
    .btn[disabled] { opacity:0.7; background:#9ca3af; }
    #reader { width:255px; margin-top:4px; margin-bottom:8px; display:none; }
    #scan-msg { color:#2563eb; font-size:0.9em; margin-bottom:8px; }
    #order-summary { margin-top:25px; display:none; }
    #order-detail { background:#f8fafc; border-radius:12px; padding:25px; border:2px solid #e2e8f0; }
    #order-detail h3 { color:#2d3748; margin:0 0 15px 0; }
    #order-detail ul { padding-left:20px; }
    #order-detail li { margin-bottom:5px; }
    #order-detail li ul { padding-left:15px; margin-top:5px; margin-bottom:0; }
    
    @media (max-width:768px){
      .input-group{grid-template-columns:1fr}
      .input-group-order{grid-template-columns:1fr}
      .electrolyte-header{grid-template-columns:1fr}
      .tpn-table{font-size:.85em;border-radius:8px}
      .table-cell{padding:8px 4px;min-height:45px}
      .component-cell{padding-left:8px;font-size:.85em}
      .result-cell{font-size:.8em}
      .header-cell{font-size:.8em;padding:8px 4px}
      .gir-display{flex-direction:column;gap:10px;text-align:center}
      .container{margin:10px;border-radius:12px}
      .content{padding:20px}
      .total-section{padding:20px}
      .total-section h2{font-size:1.3em}
      .total-calories{font-size:2em}
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>
<body>
  <main class="container">
   <header class="header">
    <h1 id="app-title">TPN Calculator</h1>
    <p id="subtitle">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å</p>
   </header>
   <div class="content">

    <!-- New HN and Ward section -->
    <section class="order-inputs">
     <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</h2>
     <div class="input-group-order">
      <!-- Left column: HN + Scan (immediately after HN) + Patient Name -->
      <div class="input-field-order">
        <label for="hn">HN</label>
        <input type="text" id="hn" autocomplete="off" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å HN ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô">
        <!-- Scan button and reader placed directly AFTER HN -->
        <button class="btn" id="scan-btn" type="button" style="margin-top:10px;">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î/QR</button>
        <div id="reader"></div>
        <small id="scan-msg"></small>
        <!-- Patient name field comes after HN + scanner -->
        <label for="patientName" style="margin-top: 10px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="patientName" autocomplete="off" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢">
      </div>
      <!-- Right column: Ward -->
      <div class="input-field-order">
        <label for="ward">Ward</label>
        <input type="text" id="ward" autocomplete="off" placeholder="‡πÄ‡∏ä‡πà‡∏ô 6A, NICU">
      </div>
     </div>
    </section>

    <!-- Basic info -->
    <section class="section">
     <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
     <div class="input-group">
      <div class="input-field"><label for="bw">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß (BW)</label>
       <div class="input-with-unit"><input type="number" inputmode="decimal" id="bw" step="0.01" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß"> <span class="unit">kg</span></div>
      </div>
      <div class="input-field"><label for="rate">Rate TPN</label>
       <div class="input-with-unit"><input type="number" inputmode="decimal" id="rate" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ"> <span class="unit">ml/hr</span></div>
      </div>
     </div>
     <div class="input-group">
      <div class="input-field"><label for="bag">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ Bag TPN</label>
       <div class="input-with-unit"><input type="number" inputmode="numeric" id="bag" step="1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ñ‡∏∏‡∏á TPN"> <span class="unit">ml</span></div>
      </div>
     </div>
    </section>

    <!-- Macronutrients -->
    <section class="section">
     <h2>Macronutrients</h2>
     <div class="input-group">
      <div class="input-field"><label for="protein">Protein</label>
       <div class="input-with-unit"><input type="number" inputmode="decimal" id="protein" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô"> <span class="unit">g/kg/day</span></div>
      </div>
      <div class="input-field"><label for="dextrose">%Dextrose</label>
       <div class="input-with-unit"><input type="number" inputmode="decimal" id="dextrose" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå Dextrose"> <span class="unit">%</span></div>
      </div>
     </div>
     <div class="input-group">
      <div class="input-field"><label for="fat">Fat</label>
       <div class="input-with-unit"><input type="number" inputmode="decimal" id="fat" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÑ‡∏Ç‡∏°‡∏±‡∏ô"> <span class="unit">g/kg/day</span></div>
      </div>
     </div>

     <div class="tpn-table">
      <div class="table-header">
       <div class="table-cell header-cell">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>
       <div class="table-cell header-cell">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (ml)</div>
       <div class="table-cell header-cell">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (kcal)</div>
       <div class="table-cell header-cell">mOsmol/L</div>
      </div>
      <div class="table-row">
       <div class="table-cell component-cell">Protein</div>
       <div class="table-cell result-cell volume-yellow" id="protein-volume">0</div>
       <div class="table-cell result-cell" id="protein-calories">0</div>
       <div class="table-cell result-cell osmol-purple" id="protein-osmol">0</div>
      </div>
      <div class="table-row">
       <div class="table-cell component-cell">Dextrose</div>
       <div class="table-cell result-cell volume-yellow" id="dextrose-volume">0</div>
       <div class="table-cell result-cell" id="dextrose-calories">0</div>
       <div class="table-cell result-cell osmol-purple" id="dextrose-osmol">0</div>
      </div>
      <div class="table-row">
       <div class="table-cell component-cell">Fat</div>
       <div class="table-cell result-cell volume-yellow" id="fat-volume">0</div>
       <div class="table-cell result-cell" id="fat-calories">0</div>
       <div class="table-cell result-cell">-</div>
      </div>
     </div>

     <div class="gir-display">
      <div class="gir-label">GIR (Glucose Infusion Rate)</div>
      <div class="calc-result gir-pink" id="gir-result">0 mg/kg/min</div>
     </div>
    </section>

    <!-- Electrolytes -->
    <section class="section">
     <h2>Electrolytes</h2>
     
     <!-- Na -->
     <div class="electrolyte-item">
      <div class="electrolyte-header">
       <div class="electrolyte-input">
        <label for="na">Na (mEq/kg/day)</label>
        <input type="text" inputmode="decimal" id="na" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Na">
       </div>
       <div class="electrolyte-result">
        <div class="electrolyte-result-label">Na ‡∏à‡∏≤‡∏Å Glycophos¬Æ</div>
        <div class="electrolyte-result-value" id="na-from-glycophos">0 mEq</div>
       </div>
      </div>
      
      <div class="source-selection">
       <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á Na ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
       <label class="source-option">
        <input type="radio" name="na-source" value="nacl" id="nacl-radio">
        <span class="source-option-label">3%NaCl (0.5 mEq/ml)</span>
        <span class="source-option-value" id="nacl-volume">0 ml</span>
       </label>
       <label class="source-option">
        <input type="radio" name="na-source" value="na-acetate" id="na-acetate-radio">
        <span class="source-option-label">Na acetate (3 mEq/ml)</span>
        <span class="source-option-value" id="na-acetate-volume">0 ml</span>
       </label>
      </div>
     </div>

     <!-- P -->
     <div class="electrolyte-item">
      <div class="electrolyte-header">
       <div class="electrolyte-input">
        <label for="p">P (Glycophos¬Æ) (mmol/kg/day)</label>
        <input type="text" inputmode="decimal" id="p" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì P">
       </div>
       <div class="electrolyte-result">
        <div class="electrolyte-result-label">P Volume</div>
        <div class="electrolyte-result-value" id="p-volume">0 ml</div>
       </div>
      </div>
     </div>

     <!-- Ca -->
     <div class="electrolyte-item">
      <div class="electrolyte-header">
       <div class="electrolyte-input">
        <label for="ca">Ca (mmol/kg/day)</label>
        <input type="text" inputmode="decimal" id="ca" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Ca">
       </div>
       <div class="electrolyte-result">
        <div class="electrolyte-result-label">Ca Volume</div>
        <div class="electrolyte-result-value" id="ca-volume">0 ml</div>
       </div>
      </div>
     </div>

     <!-- Mg -->
     <div class="electrolyte-item">
      <div class="electrolyte-header">
       <div class="electrolyte-input">
        <label for="mg">Mg (mmol/kg/day)</label>
        <input type="text" inputmode="decimal" id="mg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Mg">
       </div>
       <div class="electrolyte-result">
        <div class="electrolyte-result-label">Mg Volume</div>
        <div class="electrolyte-result-value" id="mg-volume">0 ml</div>
       </div>
      </div>
     </div>

     <!-- K -->
     <div class="electrolyte-item">
      <div class="electrolyte-header">
       <div class="electrolyte-input">
        <label for="k">K (mEq/kg/day)</label>
        <input type="text" inputmode="decimal" id="k" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì K">
       </div>
       <div style="display:grid; grid-template-columns:1fr; gap:0;">
        <!-- Placeholder for alignment -->
       </div>
      </div>
      
      <div class="source-selection">
       <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á K ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
       <label class="source-option">
        <input type="radio" name="k-source" value="kcl" id="kcl-radio">
        <span class="source-option-label">15% KCl (2 mEq/ml)</span>
        <span class="source-option-value" id="kcl-volume">0 ml</span>
       </label>
       <label class="source-option">
        <input type="radio" name="k-source" value="k-acetate" id="k-acetate-radio">
        <span class="source-option-label">K acetate (3 mEq/ml)</span>
        <span class="source-option-value" id="k-acetate-volume">0 ml</span>
       </label>
      </div>
     </div>

    </section>

    <!-- Micronutrients -->
    <section class="section">
     <h2>Micronutrients</h2>
     <div class="calculation-section" style="background:#f0fdf4; border:2px solid #bbf7d0;">
      <div class="calc-row">
       <div class="calc-label">Peditrace¬Æ (max 15 ml/day)</div>
       <div class="calc-result" id="peditrace-volume" style="background:#dcfce7; color:#166534; border:1px solid #86efac;">0 ml</div>
       <div></div>
      </div>
      <div class="calc-row">
       <div class="calc-label">Cernevit¬Æ (max 3 ml/day)</div>
       <div class="calc-result" id="cernevit-volume" style="background:#dcfce7; color:#166534; border:1px solid #86efac;">0 ml</div>
       <div></div>
      </div>
      <div class="calc-row">
       <div class="calc-label">Vitamin K</div>
       <div style="display:flex; flex-direction:column; gap:8px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="radio" name="vitamin-k-choice" value="daily" checked style="transform:scale(1.2);">
          <span style="font-weight:500;">Per day: </span>
          <span class="calc-result" id="vitamin-k-daily" style="margin-left:5px; background:#dcfce7; color:#166534; border:1px solid #86efac;">0 ml</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="radio" name="vitamin-k-choice" value="weekly" style="transform:scale(1.2);">
          <span style="font-weight:500;">Per week: </span>
          <span class="calc-result" id="vitamin-k-weekly" style="margin-left:5px; background:#dcfce7; color:#166534; border:1px solid #86efac;">0 ml</span>
        </label>
       </div>
       <div></div>
      </div>
     </div>
    </section>

    <!-- Heparin -->
    <section class="section">
     <h2>Add Heparin</h2>
     <div class="calculation-section">
      <div class="calc-row">
       <div class="calc-label">‡∏°‡∏µ PICC-line ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</div>
       <div style="display:flex; align-items:center; gap:10px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="picc-line-checkbox" style="transform:scale(1.2);"> <span style="font-weight:500;">‡∏°‡∏µ PICC-line</span>
        </label>
       </div>
       <div></div>
      </div>
      <div class="calc-row">
       <div class="calc-label">Heparin</div>
       <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span class="calc-result" id="heparin-volume" style="margin-left:5px;">0 ml</span>
        </div>
       </div>
       <div></div>
      </div>
     </div>
    </section>

    <!-- Milk -->
    <section class="section">
     <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô Calories ‡∏à‡∏≤‡∏Å‡∏ô‡∏° (feed)</h2>
     <div class="input-group">
      <div class="input-field"><label for="milk">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°</label>
       <div class="input-with-unit"><input type="number" inputmode="numeric" id="milk" step="1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°"> <span class="unit">ml</span></div>
      </div>
      <div class="input-field"><label for="total-milk">x 8 feed =</label>
       <div class="input-with-unit"><input type="number" inputmode="numeric" id="total-milk" step="1" placeholder="‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°"> <span class="unit">ml</span></div>
      </div>
     </div>
     <div class="calculation-section">
      <div class="calc-row">
       <div class="calc-label">TF ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ô‡∏°</div>
       <div class="calc-result" id="tf-from-milk">0 ml/kg/day</div>
       <div></div>
      </div>
      <div class="calc-row">
       <div class="calc-label">Calories ‡∏à‡∏≤‡∏Å‡∏ô‡∏°</div>
       <div class="calc-result" id="milk-calories-kg">0 kcal/kg/day</div>
       <div></div>
      </div>
     </div>
    </section>

    <!-- Sterile Water -->
    <section class="total-section" id="sterile-water-section" style="background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%);">
     <h2>üíß Sterile Water Volume</h2>
     <div class="total-calories" id="sterile-water-volume">0</div>
     <p>ml</p>
    </section>

    <!-- Total calories -->
    <section class="total-section">
     <h2>üéØ Total calories</h2>
     <p style="font-size:.9em; opacity:.9; margin-bottom:15px;">(Full calories = 90-120 kcal/kg/day)</p>
     <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
      <div style="text-align:center;">
       <h3 style="margin:0 0 10px 0; font-size:1.2em;">Total Calories/day</h3>
       <div class="total-calories" id="total-calories-day">0</div>
       <p>kcal/day</p>
      </div>
      <div style="text-align:center;">
       <h3 style="margin:0 0 10px 0; font-size:1.2em;">Total Calories/kg/day</h3>
       <div class="total-calories" id="total-calories-kg">0</div>
       <p>kcal/kg/day</p>
      </div>
     </div>
     <div style="background:rgba(255,255,255,0.2); border-radius:12px; padding:20px; margin-top:15px;">
      <h4 style="margin:0 0 15px 0; font-size:1.1em; text-align:center;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Calories</h4>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; text-align:center;">
       <div><p style="margin:0 0 5px 0; font-size:.9em; opacity:.8;">‡∏à‡∏≤‡∏Å PN</p><div style="font-size:1.3em; font-weight:600;" id="breakdown-pn">0</div><p style="margin:5px 0 0 0; font-size:.8em;">kcal/kg/day</p></div>
       <div><p style="margin:0 0 5px 0; font-size:.9em; opacity:.8;">‡∏à‡∏≤‡∏Å‡∏ô‡∏°</p><div style="font-size:1.3em; font-weight:600;" id="breakdown-milk">0</div><p style="margin:5px 0 0 0; font-size:.8em;">kcal/kg/day</p></div>
       <div><p style="margin:0 0 5px 0; font-size:.9em; opacity:.8;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><div style="font-size:1.3em; font-weight:600;" id="breakdown-total">0</div><p style="margin:5px 0 0 0; font-size:.8em;">kcal/kg/day</p></div>
      </div>
     </div>
    </section>

    <!-- Total mOsmol -->
    <section class="total-section" id="osmol-section" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);">
     <h2>Total mOsmol/L</h2>
     <p style="font-size:.9em; opacity:.9; margin-bottom:15px;">(&lt; 900 mOsmol/L ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á peripheral)</p>
     <div class="total-calories" id="total-osmol">0</div>
     <p>mOsmol/L</p>
    </section>

    <!-- Submit Button and Order Summary -->
    <div style="text-align:center; margin:30px 0;">
     <button id="submit-btn" class="btn">Submit Order & ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF</button>
    </div>

    <div id="order-summary">
     <div id="order-detail" style="background:#f8fafc; border-radius:12px; padding:25px; border:2px solid #e2e8f0;">
      <h3>TPN Order : HN <span id="summary-hn"></span> | Ward <span id="summary-ward"></span></h3>
      <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: <span id="summary-date"></span></div>
      <div>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô:
       <ul>
        <li>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: <span id="summary-bw"></span> kg</li>
        <li>Rate: <span id="summary-rate"></span> ml/hr</li>
        <li>Bag: <span id="summary-bag"></span> ml</li>
       </ul>
      </div>
      <div>Macronutrients:
       <ul>
        <li>Protein: <span id="summary-protein"></span> g/kg/day (<span id="summary-protein-vol"></span> ml)</li>
        <li>Dextrose: <span id="summary-dextrose"></span> % (<span id="summary-dextrose-vol"></span> ml)</li>
        <li>Fat: <span id="summary-fat"></span> g/kg/day (<span id="summary-fat-vol"></span> ml)</li>
        <li>GIR: <span id="summary-gir"></span> mg/kg/min</li>
       </ul>
      </div>
      <div>Electrolytes:
       <ul>
        <li>Na: <span id="summary-na"></span> mEq/kg/day (‡∏à‡∏≤‡∏Å Glycophos <span id="summary-na-glyco"></span> mEq, ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏≤‡∏Å <span id="summary-na-source"></span>)</li>
        <li>P: <span id="summary-p"></span> mmol/kg/day (<span id="summary-p-vol"></span> ml)</li>
        <li>Ca: <span id="summary-ca"></span> mmol/kg/day (<span id="summary-ca-vol"></span> ml)</li>
        <li>Mg: <span id="summary-mg"></span> mmol/kg/day (<span id="summary-mg-vol"></span> ml)</li>
        <li>K: <span id="summary-k"></span> mEq/kg/day (<span id="summary-k-source"></span>)</li>
       </ul>
      </div>
      <div>‡∏ô‡∏° ‡πÅ‡∏•‡∏∞ Sterile Water:
       <ul>
        <li>Milk: <span id="summary-milk"></span> ml</li>
        <li>Calories ‡∏à‡∏≤‡∏Å‡∏ô‡∏°: <span id="summary-milk-cal"></span> kcal/kg/day</li>
        <li>Sterile Water: <span id="summary-sw"></span> ml</li>
       </ul>
      </div>
      <div>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°:
       <ul>
        <li>Total Calories: <span id="summary-total-cal"></span> kcal/day, <span id="summary-total-cal-kg"></span> kcal/kg/day</li>
        <li>Total mOsmol: <span id="summary-total-osmol"></span> mOsmol/L</li>
       </ul>
      </div>
     </div>
    </div>

   </div>
  </main>

  <script>
    const defaultConfig = { app_title:"TPN Calculator", subtitle:"‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å" };

    // 1dp special rounding
    function r1(v){ if(!isFinite(v)||v===0) return 0; const h=Math.floor(v*100); const d2=h%10; return d2===9? Math.ceil(v*10)/10 : Math.floor(v*10)/10; }
    // int special rounding
    function r0(v){ if(!isFinite(v)||v===0) return 0; const m=v*10; const d1=Math.floor(m)%10; return d1===9? Math.ceil(v) : Math.floor(v); }

    function calculateTPN(){
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const rate = parseFloat(document.getElementById('rate').value) || 0;
      const bag = parseFloat(document.getElementById('bag').value) || 0;
      const protein = parseFloat(document.getElementById('protein').value) || 0;
      const dextrose = parseFloat(document.getElementById('dextrose').value) || 0;
      const fat = parseFloat(document.getElementById('fat').value) || 0;
      const milk = parseFloat(document.getElementById('milk').value) || 0;
      const totalMilk = parseFloat(document.getElementById('total-milk').value) || (milk*8);
      const p = parseFloat(document.getElementById('p').value) || 0;
      const na = parseFloat(document.getElementById('na').value) || 0;
      const k = parseFloat(document.getElementById('k').value) || 0;
      const ca = parseFloat(document.getElementById('ca').value) || 0;
      const mg = parseFloat(document.getElementById('mg').value) || 0;

      // Macronutrients
      const proteinVol_raw = (bw*protein*100)/10;
      const proteinCal_raw = bw*protein*4;
      const proteinOsm_raw = bag>0 ? (protein*bw*1000*10)/bag : 0;

      const dextroseVol_raw = ((dextrose*bag)/100)*2;
      const dextroseCal_raw = (dextrose*bag*3.4)/100;
      const dextroseOsm_raw = bag>0 ? (dextrose*1000*5)/100 : 0;

      const gir_raw = (bw>0) ? (dextrose*rate)/(6*bw) : 0;

      const fatVol_1 = r1(fat*bw*5);
      const fatCal_raw = fat*bw*10;

      const tfMilk_raw = (bw>0) ? totalMilk/bw : 0;

      // Electrolytes
      const pVol_1 = r1(p*bw);
      const naFromGly = pVol_1*2;
      const naReq_raw = na*bw;
      const rNa_raw = Math.max(0, naReq_raw - naFromGly);

      // Na source volumes (always calculate for display)
      const naclVol_1 = rNa_raw>0 ? r1(rNa_raw/0.5) : 0;
      const naAcVol_1 = rNa_raw>0 ? r1(rNa_raw/3.0) : 0;

      // K source volumes (always calculate for display)
      const totalK_raw = k*bw;
      const kclVol_1 = totalK_raw>0 ? r1(totalK_raw/2.0) : 0;
      const kAcVol_1 = totalK_raw>0 ? r1(totalK_raw/3.0) : 0;

      // Ca / Mg
      const caVol_1 = r1((ca*bw)/0.25);
      const mgVol_1 = r1((mg*bw)/2.0);

      // Micro
      let pedit_raw = 1*bw; let peditExceeded=false; if(pedit_raw>15){ pedit_raw=15; peditExceeded=true; }
      const pedit_1 = r1(pedit_raw);
      let cern_raw = 1*bw; let cernExceeded=false; if(cern_raw>3){ cern_raw=3; cernExceeded=true; }
      const cern_1 = r1(cern_raw);

      // Vitamin K
      const vitK_day_raw = (10*bw/1000)*0.5;
      const vitK_week_raw = vitK_day_raw*7;

      // Heparin (0 unless PICC checked)
      const picc = document.getElementById('picc-line-checkbox')?.checked || false;
      const hep_calc_1 = r1(bag>0 ? bag/50 : 0);
      const hep_disp_1 = picc ? hep_calc_1 : 0;
      const hep_included = hep_disp_1;

      // Total used volume
      let totalUsed = 0;
      totalUsed += proteinVol_raw;
      totalUsed += dextroseVol_raw;
      totalUsed += pVol_1;
      totalUsed += caVol_1;
      totalUsed += mgVol_1;
      totalUsed += pedit_1;
      totalUsed += cern_1;
      totalUsed += hep_included;

      // Check which Na source is selected
      const naSource = document.querySelector('input[name="na-source"]:checked')?.value;
      if(naSource === 'nacl') totalUsed += naclVol_1;
      if(naSource === 'na-acetate') totalUsed += naAcVol_1;

      // Check which K source is selected
      const kSource = document.querySelector('input[name="k-source"]:checked')?.value;
      if(kSource === 'kcl') totalUsed += kclVol_1;
      if(kSource === 'k-acetate') totalUsed += kAcVol_1;

      const vkChoice = document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'daily';
      if(vkChoice==='daily') totalUsed += vitK_day_raw; else totalUsed += vitK_week_raw;

      const swVol = Math.floor(bag - totalUsed);

      // Osmol
      const elyteOsm_raw = bag>0 ? ((na+k)*bw*2*1000)/bag : 0;
      const totalOsm_raw = proteinOsm_raw + dextroseOsm_raw + elyteOsm_raw;

      // Calories
      const pnCalDay = proteinCal_raw + dextroseCal_raw + fatCal_raw;
      const pnCalKg = bw>0 ? pnCalDay/bw : 0;
      const milkCalDay = totalMilk*20/30;
      const milkCalKg = bw>0 ? milkCalDay/bw : 0;
      const totalCalDay = pnCalDay + milkCalDay;

      const dispPN = r0(pnCalKg);
      const dispMilk = r0(milkCalKg);
      const dispTotalKg = dispPN + dispMilk;

      // Update UI
      document.getElementById('protein-volume').textContent = r1(proteinVol_raw).toFixed(1);
      document.getElementById('protein-calories').textContent = r1(proteinCal_raw).toFixed(1);
      document.getElementById('protein-osmol').textContent = r1(proteinOsm_raw).toFixed(1);

      document.getElementById('dextrose-volume').textContent = r1(dextroseVol_raw).toFixed(1);
      document.getElementById('dextrose-calories').textContent = r1(dextroseCal_raw).toFixed(1);
      document.getElementById('dextrose-osmol').textContent = r1(dextroseOsm_raw).toFixed(1);

      document.getElementById('gir-result').textContent = r1(gir_raw).toFixed(1) + ' mg/kg/min';

      document.getElementById('fat-volume').textContent = fatVol_1.toFixed(1);
      document.getElementById('fat-calories').textContent = r1(fatCal_raw).toFixed(1);

      document.getElementById('tf-from-milk').textContent = r0(tfMilk_raw) + ' ml/kg/day';
      document.getElementById('milk-calories-kg').textContent = dispMilk + ' kcal/kg/day';

      document.getElementById('p-volume').textContent = pVol_1.toFixed(1) + ' ml';
      document.getElementById('na-from-glycophos').textContent = r1(naFromGly).toFixed(1) + ' mEq';
      document.getElementById('nacl-volume').textContent = naclVol_1.toFixed(1) + ' ml';
      document.getElementById('na-acetate-volume').textContent = naAcVol_1.toFixed(1) + ' ml';

      document.getElementById('kcl-volume').textContent = kclVol_1.toFixed(1) + ' ml';
      document.getElementById('k-acetate-volume').textContent = kAcVol_1.toFixed(1) + ' ml';

      document.getElementById('ca-volume').textContent = caVol_1.toFixed(1) + ' ml';
      document.getElementById('mg-volume').textContent = mgVol_1.toFixed(1) + ' ml';

      const pedEl = document.getElementById('peditrace-volume');
      pedEl.textContent = pedit_1.toFixed(1) + ' ml';
      pedEl.style.background = '#dcfce7';
      pedEl.style.color = '#166534';
      pedEl.style.border = '1px solid #86efac';

      const cerEl = document.getElementById('cernevit-volume');
      cerEl.textContent = cern_1.toFixed(1) + ' ml';
      cerEl.style.background = '#dcfce7';
      cerEl.style.color = '#166534';
      cerEl.style.border = '1px solid #86efac';

      // Sterile water
      document.getElementById('sterile-water-volume').textContent = swVol;
      const swSec = document.getElementById('sterile-water-section');
      swSec.style.background = swVol<0 ? 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)' : 'linear-gradient(135deg,#06b6d4 0%,#0891b2 100%)';

      // Total mOsmol display + color change at 900
      document.getElementById('total-osmol').textContent = '~' + r0(totalOsm_raw);
      const osmolSec = document.getElementById('osmol-section');
      osmolSec.style.background = r0(totalOsm_raw) > 900 ? 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)' : 'linear-gradient(135deg,#10b981 0%,#059669 100%)';

      // Totals
      document.getElementById('total-calories-day').textContent = r0(totalCalDay);
      document.getElementById('total-calories-kg').textContent = dispTotalKg;
      document.getElementById('breakdown-pn').textContent = dispPN;
      document.getElementById('breakdown-milk').textContent = dispMilk;
      document.getElementById('breakdown-total').textContent = dispTotalKg;
    }

    // -------------------------------------------------------------
    // Barcode scanning
    // -------------------------------------------------------------
    const readerEl = document.getElementById('reader');
    const scanBtn = document.getElementById('scan-btn');
    let qrScanner = null;
    let scanning = false;

    function stopScan(){
      if(qrScanner){
        qrScanner.stop().then(()=>{
          readerEl.style.display='none'; scanning=false; scanBtn.disabled=false;
        }).catch(()=>{ readerEl.style.display='none'; scanning=false; scanBtn.disabled=false; });
      }
    }

    scanBtn.addEventListener('click', async () => {
      if(scanning) return;
      scanning = true;
      scanBtn.disabled = true;
      readerEl.style.display = 'block';
      document.getElementById('scan-msg').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
      try{
        qrScanner = new Html5Qrcode('reader');
        // start with default camera; library will prompt for permissions
        await qrScanner.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: { width: 220, height: 120 }, formatsToSupport: [Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.QR_CODE] },
          (decodedText) => {
            document.getElementById('hn').value = decodedText;
            document.getElementById('scan-msg').textContent = `‡∏≠‡πà‡∏≤‡∏ô HN: ${decodedText} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
            stopScan();
          },
          () => {}
        );
      }catch(e){
        document.getElementById('scan-msg').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
        stopScan();
      }
    });

    // -------------------------------------------------------------
    // Submit and PDF Generation
    // -------------------------------------------------------------
    document.getElementById('submit-btn').onclick = async function() {
      const hn = document.getElementById('hn').value.trim();
      const ward = document.getElementById('ward').value.trim();
      const name = document.getElementById('patientName').value.trim();

      if (!hn) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å HN ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á Order');
        document.getElementById('hn').focus();
        return;
      }

      document.getElementById('summary-hn').textContent = hn;
      document.getElementById('summary-ward').textContent = ward || '-';
      document.getElementById('summary-date').textContent = new Date().toLocaleString('th-TH');
      document.getElementById('summary-bw').textContent = document.getElementById('bw').value || '0';
      document.getElementById('summary-rate').textContent = document.getElementById('rate').value || '0';
      document.getElementById('summary-bag').textContent = document.getElementById('bag').value || '0';

      document.getElementById('summary-protein').textContent = document.getElementById('protein').value || '0';
      document.getElementById('summary-protein-vol').textContent = document.getElementById('protein-volume').textContent;
      document.getElementById('summary-dextrose').textContent = document.getElementById('dextrose').value || '0';
      document.getElementById('summary-dextrose-vol').textContent = document.getElementById('dextrose-volume').textContent;
      document.getElementById('summary-fat').textContent = document.getElementById('fat').value || '0';
      document.getElementById('summary-fat-vol').textContent = document.getElementById('fat-volume').textContent;
      document.getElementById('summary-gir').textContent = document.getElementById('gir-result').textContent.replace(' mg/kg/min','');

      document.getElementById('summary-na').textContent = document.getElementById('na').value || '0';
      document.getElementById('summary-na-glyco').textContent = document.getElementById('na-from-glycophos').textContent.replace(' mEq','');
      const naSource = document.querySelector('input[name="na-source"]:checked')?.value;
      let naSourceText = '-';
      if(naSource==='nacl') naSourceText = '3%NaCl ' + document.getElementById('nacl-volume').textContent;
      if(naSource==='na-acetate') naSourceText = 'Na acetate ' + document.getElementById('na-acetate-volume').textContent;
      document.getElementById('summary-na-source').textContent = naSourceText;

      document.getElementById('summary-p').textContent = document.getElementById('p').value || '0';
      document.getElementById('summary-p-vol').textContent = document.getElementById('p-volume').textContent.replace(' ml','');
      document.getElementById('summary-ca').textContent = document.getElementById('ca').value || '0';
      document.getElementById('summary-ca-vol').textContent = document.getElementById('ca-volume').textContent.replace(' ml','');
      document.getElementById('summary-mg').textContent = document.getElementById('mg').value || '0';
      document.getElementById('summary-mg-vol').textContent = document.getElementById('mg-volume').textContent.replace(' ml','');

      const kSource = document.querySelector('input[name="k-source"]:checked')?.value;
      let kSourceText = '-';
      if(kSource==='kcl') kSourceText = 'KCl ' + document.getElementById('kcl-volume').textContent;
      if(kSource==='k-acetate') kSourceText = 'K acetate ' + document.getElementById('k-acetate-volume').textContent;
      document.getElementById('summary-k').textContent = document.getElementById('k').value || '0';
      document.getElementById('summary-k-source').textContent = kSourceText;

      document.getElementById('summary-peditrace').textContent = document.getElementById('peditrace-volume').textContent.replace(' ml','');
      document.getElementById('summary-cernevit').textContent = document.getElementById('cernevit-volume').textContent.replace(' ml','');
      const vkDaily = document.getElementById('vitamin-k-daily').textContent;
      const vkWeekly = document.getElementById('vitamin-k-weekly').textContent;
      const vkChoice = document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'daily';
      document.getElementById('summary-vit-k').textContent = vkChoice==='daily' ? ('Daily ' + vkDaily) : ('Weekly ' + vkWeekly);

      const heparinVol = document.getElementById('heparin-volume').textContent;
      document.getElementById('summary-heparin').textContent = heparinVol.replace(' ml','');
      document.getElementById('summary-picc').textContent = document.getElementById('picc-line-checkbox').checked ? '‡∏°‡∏µ' : '‡πÑ‡∏°‡πà‡∏°‡∏µ';

      document.getElementById('summary-milk').textContent = document.getElementById('total-milk').value || '0';
      document.getElementById('summary-milk-cal').textContent = document.getElementById('milk-calories-kg').textContent.replace(' kcal/kg/day','');
      document.getElementById('summary-sw').textContent = document.getElementById('sterile-water-volume').textContent;

      document.getElementById('summary-total-cal').textContent = document.getElementById('total-calories-day').textContent;
      document.getElementById('summary-total-cal-kg').textContent = document.getElementById('total-calories-kg').textContent;
      document.getElementById('summary-total-osmol').textContent = document.getElementById('total-osmol').textContent.replace('~','');

      // Show summary for PDF conversion
      document.getElementById('order-summary').style.display = 'block';

      const orderDiv = document.getElementById('order-detail');
      const canvas = await html2canvas(orderDiv, { scale: 3, allowTaint: true });
      const imgData = canvas.toDataURL('image/jpeg', 1.0);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      const imgWidth = 210; 
      const pageHeight = 297; 
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;

      doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        position = heightLeft - imgHeight;
        doc.addPage();
        doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      doc.save(`TPN_Order_HN_${hn}_${new Date().toISOString().slice(0, 10)}.pdf`);

      // Hide summary after saving (optional)
      document.getElementById('order-summary').style.display = 'none';
    };

    // Recalculate on input
    ['bw','rate','bag','protein','dextrose','fat','p','na','k','ca','mg','picc-line-checkbox','milk','total-milk'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('input', calculateTPN);
    });
    document.querySelectorAll('input[type="radio"]').forEach(r=>r.addEventListener('change', calculateTPN));

    // Auto-calc total milk = 8 feeds
    const milkEl=document.getElementById('milk');
    if(milkEl){ milkEl.addEventListener('input', function(){ const milk=parseFloat(this.value)||0; const t=document.getElementById('total-milk'); if(t) t.value=(milk*8).toFixed(0); calculateTPN(); }); }
    const totMilkEl=document.getElementById('total-milk'); if(totMilkEl){ totMilkEl.addEventListener('input', calculateTPN); }

    window.addEventListener('load', function() {
      if (window.elementSdk && window.elementSdk.init) {
           window.elementSdk.init({ });
      }
      calculateTPN();
    });
  </script>
</body>
</html>